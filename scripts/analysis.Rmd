---
title: ""
author: ""
date: ""
output: github_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE,
                      fig.align = "center",
                      out.width = "90%",
                      message = FALSE,
                      warning = FALSE,
                      fig.width = 9, 
                      fig.asp = 0.4, 
                      dpi = 150)

# Load libraries
library(tidyverse)
library(stars)
library(lubridate)

# Load files
belem <- st_read(here::here("data/belem.gpkg"))
land <- st_read(here::here("data/land.gpkg"))

readRDS(here::here("data", "chelsea_diff_biovars.rds")) %>%
    merge() -> data_chelsea

readRDS(here::here("data", "worldclim_diff_biovars.rds")) %>% 
    merge() -> data_worldclim

biovar_names <- c("Δ Annual Mean Temperature", # 1
                  "Δ Mean Diurnal Range",
                  "Δ Isothermality", # 3
                  "Δ Temperature Seasonality",
                  "Δ Max Temperature of Warmest Month", # 5
                  "Δ Min Temperature of Coldest Month",
                  "Δ Temperature Annual Range", # 7
                  "Δ Mean Temperature of Wettest Quarter",
                  "Δ Mean Temperature of Driest Quarter",
                  "Δ Mean Temperature of Warmest Quarter", # 10
                  "Δ Mean Temperature of Coldest Quarter",
                  "Δ Annual Precipitation",
                  "Δ Precipitation of Wettest Month", # 13
                  "Δ Precipitation of Driest Month",
                  "Δ Precipitation Seasonality (Coefficient of Variation)", # 15
                  "Δ Precipitation of Wettest Quarter",
                  "Δ Precipitation of Driest Quarter", # 17
                  "Δ Precipitation of Warmest Quarter",
                  "Δ Precipitation of Coldest Quarter") # 19


# Functions
func_maps <- function(data, v){
    
    data %>% 
    slice(biovars, v) %>% 
    
    {
        ggplot() +
            geom_stars(data = .) +
            
            geom_sf(data = aoi_land %>% filter(lc == "w"), 
                    fill = "black", alpha = 0.15, color = 'black', size = 0.2) +
            
            # geom_sf(data = belem_l, aes(linetype = as_factor(linetype))) +
            # scale_linetype_manual(values = c("1" = "3333", "2" = "solid"), guide = 'none') +
            geom_sf(data = belem, fill = NA, linetype = "2222", color = "black") +
            # geom_sf(data = belem, fill = NA, color = "black") +
            
            facet_wrap(~attributes, nrow = 1) +
            
            scale_x_continuous(breaks = c(-48.7, -48.2)) +
            scale_y_continuous(breaks = c(-1.6, -1)) +
            
            labs(title = biovar_names[v]) +
            guides(fill = guide_legend(label.position = "bottom", keyheight = 0.6, nrow = 1)) +
            
            theme(axis.title = element_blank(),
                  legend.position = "bottom") +
            
            coord_sf(ylim = c(st_get_dimension_values(., "y") %>% last(),
                              st_get_dimension_values(., "y") %>% first()),
                     xlim = c(st_get_dimension_values(., "x") %>% first(),
                              st_get_dimension_values(., "x") %>% last()))
        
    }
}

# Prepare polygons for plotting
data_worldclim %>% 
    st_bbox() %>%
    st_as_sfc() -> aoi

# belem %>% 
#     st_geometry() %>% 
#     st_cast("POLYGON") %>% 
#     {c(aoi, .)} %>% 
#     st_intersection() %>% 
#     st_sf() %>% 
#     mutate(lc = c("w", "l")) -> aoi_belem

land %>% 
    filter(scalerank <= 6) %>%
    st_geometry() %>% 
    st_crop(aoi) %>%
    st_cast("POLYGON") %>% 
    {c(aoi, .)} %>% 
    st_intersection() %>% 
    st_sf() %>%
    # slice(-4) %>% # artifact
    mutate(lc = c("w", "l", "l", "l", "l", "l")) -> aoi_land

# belem %>% 
#     st_simplify(dTolerance = 700) %>%
#     st_cast("POLYGON") %>%
#     st_cast("LINESTRING") %>% 
#     st_sf() %>% 
#     st_write(here::here("data/belem_l.gpkg"))

belem_l <- st_read(here::here("data", "belem_l.gpkg"))

```

## Belém
```{r out.width="40%"}
knitr::include_graphics("analysis_files/figure-markdown_github/location.png")

```

---

```{r eval=FALSE, include=FALSE}
func_maps(data_chelsea, 4) + 
    scale_fill_viridis_c(name = NULL, option = "B", direction = 1) + 
    labs(subtitle = "CHELSEA:")

```

```{r temp_seasonality_wc}
func_maps(data_worldclim, 4) + 
    scale_fill_gradientn(name = "°C", colors = viridis::plasma(15)[-(1:2)]) +
    labs(caption = "Data source: WorldClim's CMIP6 downscaled projections")

```
This figure shows future changes in the **standard deviation of monthly mean temperatures** (×100) relative to 1970-2000. Higher values indicate that the "spread" of temperatures within periods will increase over time (hot months will become hotter and cold months colder).
    
---
  
```{r eval=FALSE, include=FALSE}
func_maps(data_chelsea, 7) + 
    scale_fill_viridis_c(name = NULL, option = "B", direction = 1) + 
    labs(subtitle = "CHELSEA:")

```

```{r temp_annual_range_wc}
func_maps(data_worldclim, 7) + 
    scale_fill_gradientn(name = "°C", colors = viridis::plasma(15)[-(1:2)]) +
    labs(caption = "Data source: WorldClim's CMIP6 downscaled projections")

```
This figure shows future changes in **the difference between the highest maximum temp. and the lowest minimum temp. within a year** relative to 1970-2000. Higher values indicate that that difference will increase over time. The difference between this figure and the previous one is that this one considers extreme values (max and min temps) rather than the mean, and it analyzes those differences annually rather than by time period. But in a way it says a similar story: the hot months of the year will get hotter and cold months colder. If a choice needs to be made between this or the previous figure for the one-pager, I'd choose this one since it is easier to interpret.

---

```{r eval=FALSE, include=FALSE}
func_maps(data_chelsea, 13) + 
    scale_fill_viridis_c(name = NULL, option = "C", direction = -1) + 
    labs(subtitle = "CHELSEA:")

```

```{r precip_wettest_month}
func_maps(data_worldclim, 13) + 
    scale_fill_gradientn(name = "mm", colors = RColorBrewer::brewer.pal(10, "RdYlBu"), n.breaks = 6) +
    labs(caption = "Data source: WorldClim's CMIP6 downscaled projections")

```
This figure shows future changes in the **precipitation of the wettest month of a year** relative to 1970-2000. Higher values indicate that that the wettest month will become wetter over time. Notice that the ensemble of models project a reduction of precipitation until 2060-2080 (first three facets), and after that, an abrupt increase (last facet). 
  
---

```{r eval=FALSE, include=FALSE}
func_maps(data_chelsea, 14) + 
    scale_fill_viridis_c(name = NULL, option = "C", direction = -1) + 
    labs(subtitle = "CHELSEA:")

```

```{r precip_driest_month}
func_maps(data_worldclim, 14) + 
    scale_fill_gradientn(name = "mm", colors = RColorBrewer::brewer.pal(9, "YlOrBr") %>% rev()) +
    labs(caption = "Data source: WorldClim's CMIP6 downscaled projections")

```
This figure shows future changes in the **precipitation of the driest month of a year** relative to 1970-2000. Higher values indicate that that the driest month will become drier over time.  

---

```{r length_fire_seas_circular, fig.asp = 0.5}

"~/Documents/outside_Insync/Data/fwi_ww/Wellington_Wildfire_REMO_diffFWIdays_mean_rawcount_SAM_noReference_2021-2050_1971-2000.tif" %>% 
    read_stars(proxy = F) -> fwi_diff

st_point(c(-48.5161, -1.3679)) %>%
    st_sfc(crs = st_crs(fwi_diff)) -> belem_pt

belem_pt %>%
    .[[1]] %>% # sfg
    st_buffer(3) %>% 
    st_sfc(crs = st_crs(fwi_diff)) -> belem_buf

# land %>% 
#     st_intersection(belem_buf) %>% 
#     st_geometry() %>% 
#     st_cast("MULTIPOLYGON") %>% 
#     st_simplify(dTolerance = 5000) -> land_belem_buf

fwi_diff[belem_buf] %>% 
    setNames("inc") %>%
    mutate(inc = ifelse(inc <= 0, 0, inc)) %>%
    
{
    ggplot() +
        geom_stars(data = .) +
        
        geom_sf(data = belem_pt, color = "black", fill = "white", shape = 21, stroke = 0.8) +
        # geom_sf(data = land_belem_buf, fill = NA) + 
        
        theme_void() +
        theme(legend.position = "bottom") +
        guides(fill = guide_legend(label.position = "bottom", keyheight = 0.6, nrow = 1)) +
        scale_fill_gradientn(name = "days", 
                             colors = viridis::inferno(15)[-(1:2)] %>% rev(), 
                             na.value = "transparent",
                             n.breaks = 6) +
        
        
        labs(title = "Change in the length of the fire season\nwithin a ~300 km radius from Belém",
             subtitle = "(2020-2050 - 1970-2000)",
             caption = "Data source: REMO")
}

```
This figure shows future changes in the **length of the fire season** in the surroundings of Belem relative to 1970-2000. Higher values indicate an increase (in days) of such length, and thus, more risk of wildfires. We think this figure is relevant as it suggests Belem's exposure to worsening air quality over time.

---

```{r length_fire_seas_para, fig.asp=0.5}

"/home/cdobler/Documents/Insync/Research/Data/Spatial/ne_10m_admin_1_states_provinces/" %>%
    list.files(full.names = T) %>% 
    .[str_detect(., "shp")] %>% 
    st_read(quiet = T) %>% 
    
    filter(iso_a2 == "BR",
           name == "Pará") %>% 
    select(geometry) -> para

para %>% 
    st_simplify(dTolerance = 5000) -> para

st_bbox(para) %>% 
    st_as_sfc() %>% 
    st_sf() %>% 
    st_buffer(100000) %>% 
    st_bbox() -> bb

fwi_diff[bb] %>%
    setNames("inc") %>%
    mutate(inc = ifelse(inc <= 0, 0, inc)) %>%
{
    ggplot() +
        geom_stars(data = .) +
        geom_sf(data = para, fill = NA, color = "black", size = 0.3) +
        geom_sf(data = belem_pt, color = "black", fill = "white", shape = 21, stroke = 0.8) +
        scale_x_continuous(breaks = c(-58, -48)) +
        scale_y_continuous(breaks = c(2, -8)) +
        labs(title = "Change in the length of\nthe fire season in Pará",
             subtitle = "(2020-2050 - 1971-2000)",
             caption = "Data source: REMO") +
        theme(axis.title = element_blank(),
              legend.position = "bottom") +
        guides(fill = guide_legend(label.position = "bottom", keyheight = 0.6, nrow = 1)) +
        scale_fill_gradientn(name = "days", 
                             colors = rev(viridis::inferno(15)[-(1:2)]), 
                             na.value = "transparent",
                             n.breaks = 6)
    
}

```
Same as above, but for the whole state of Pará.

---

```{r wetbulb_temp, out.width = "60%", fig.width = 6, fig.asp = 0.8} 

wetbulb_data <- here::here("data", "remo_wetbulb.rds") %>% readRDS()

wetbulb_data %>% 
    map_df(function(s){
        
        s %>% 
            st_apply(3, mean) %>%
            as_tibble() %>% 
            group_by(year = year(time)) %>% 
            summarize(count = sum(mean >= 28)) %>% 
            mutate(model = names(s))
    }) %>% 
    
    group_by(year) %>% 
    summarize(count = mean(count)) -> tb
    
tb %>% 
    ggplot(aes(x = year, y = count)) +
    geom_smooth(color = "transparent") +
    geom_point(aes(color = count)) +
    scale_color_viridis_c(option = "C") +
    scale_x_continuous(breaks = seq(1970, 2090, 20)) +
    theme(axis.title.x = element_blank(),
          legend.position = 'none') +
    labs(title = "Wet-bulb temperature",
         subtitle = "Change in the number of days/year over 28 °C",
         caption = "Data source: REMO",
         y = "days/year")

```
This figure shows historical and future **frequency of days/year over 28 C of wet-bulb temperatures**. Wet-bulb temperature is a "feels-like" temperature indicator (strictly speaking, it is defined as the air temperature at 100% relative humidity). A wet-bulb temperature of 28 is considered dangerous for humans; continued exposure to it can lead to severe heat stress.

